"use strict";const i=require("electron"),v=require("node:child_process"),d=require("node:path"),c=require("node:fs"),_=require("node:crypto");class V{constructor(t){const s=i.app.getPath("userData");this.path=d.join(s,t);const r="game-vault-secure-storage-key-v1";this.encryptionKey=_.scryptSync(r,"salt",32)}get(t){try{if(!c.existsSync(this.path))return;const r=JSON.parse(c.readFileSync(this.path,"utf8"))[t];return r?typeof r=="string"&&r.startsWith("ENC:")?this.decrypt(r.substring(4)):r:void 0}catch(s){console.error("Error reading store:",s);return}}set(t,s,r=!1){try{let e={};c.existsSync(this.path)&&(e=JSON.parse(c.readFileSync(this.path,"utf8"))),r?e[t]="ENC:"+this.encrypt(s):e[t]=s,c.writeFileSync(this.path,JSON.stringify(e,null,2))}catch(e){console.error("Error writing to store:",e)}}encrypt(t){const s=_.randomBytes(16),r=_.createCipheriv("aes-256-cbc",this.encryptionKey,s);let e=r.update(JSON.stringify(t));return e=Buffer.concat([e,r.final()]),s.toString("hex")+":"+e.toString("hex")}decrypt(t){const s=t.split(":"),r=Buffer.from(s.shift(),"hex"),e=Buffer.from(s.join(":"),"hex"),C=_.createDecipheriv("aes-256-cbc",this.encryptionKey,r);let f=C.update(e);return f=Buffer.concat([f,C.final()]),JSON.parse(f.toString())}}const z=new V("data.json");i.ipcMain.handle("save-data",async(n,t,s,r=!1)=>(z.set(t,s,r),!0));i.ipcMain.handle("load-data",async(n,t)=>z.get(t));i.ipcMain.handle("select-game-exe",async()=>(await i.dialog.showOpenDialog({properties:["openFile"],filters:[{name:"Executables",extensions:["exe"]}]})).filePaths[0]);i.ipcMain.handle("select-folder",async()=>(await i.dialog.showOpenDialog({properties:["openDirectory"]})).filePaths[0]);i.ipcMain.handle("save-backup",async(n,t)=>{const s=await i.dialog.showSaveDialog({title:"Save Backup",defaultPath:"gamevault-backup.json",filters:[{name:"JSON",extensions:["json"]}]});return!s.canceled&&s.filePath?(c.writeFileSync(s.filePath,t),!0):!1});i.ipcMain.handle("load-backup",async()=>{const n=await i.dialog.showOpenDialog({title:"Load Backup",filters:[{name:"JSON",extensions:["json"]}],properties:["openFile"]});if(!n.canceled&&n.filePaths.length>0){const t=c.readFileSync(n.filePaths[0],"utf-8");return JSON.parse(t)}return null});i.ipcMain.handle("open-path",async(n,t)=>{i.shell.showItemInFolder(t)});i.ipcMain.handle("select-image",async()=>(await i.dialog.showOpenDialog({properties:["openFile"],filters:[{name:"Images",extensions:["jpg","png","webp","jpeg"]}]})).filePaths[0]);i.ipcMain.handle("launch-external",async(n,t)=>{try{return await i.shell.openExternal(t),!0}catch(s){return console.error("Failed to open external protocol:",s),!1}});i.ipcMain.handle("window-minimize",()=>{a==null||a.minimize()});i.ipcMain.handle("window-maximize",()=>{a!=null&&a.isMaximized()?a.unmaximize():a==null||a.maximize()});i.ipcMain.handle("window-close",()=>{a==null||a.close()});i.ipcMain.handle("launch-game",async(n,t)=>new Promise((s,r)=>{const e=d.basename(t.executablePath);console.log(`Preparing to launch ${e}...`),t.steamAppId?(console.log(`Launching Steam game: ${t.steamAppId}`),i.shell.openExternal(`steam://run/${t.steamAppId}`)):(console.log(`Launching executable: ${t.executablePath}`),v.spawn(t.executablePath,[],{detached:!0,stdio:"ignore",cwd:d.dirname(t.executablePath)}).unref()),s(!0);let C=0;const f=30,l=()=>{v.exec("tasklist /FO CSV /NH",(b,F)=>{b&&console.error("Tasklist error:",b);const y=F.toLowerCase(),E=e.toLowerCase();if(y.includes(`"${E}"`)){console.log(`Game process ${e} detected! Monitoring...`);const k=setInterval(()=>{v.exec("tasklist /FO CSV /NH",(A,o)=>{o.toLowerCase().includes(`"${E}"`)||(clearInterval(k),console.log(`Game process ${e} exited.`),a==null||a.webContents.send("game-exited"))})},2e3)}else C++,C<f?setTimeout(l,2e3):(console.log(`Timed out waiting for ${e} to start.`),a==null||a.webContents.send("game-exited"))})};setTimeout(l,2e3)}));i.ipcMain.handle("stop-game",async(n,t)=>{const s=d.basename(t);return console.log(`Stopping game: ${s}`),new Promise(r=>{v.exec(`taskkill /IM "${s}" /F`,(e,C,f)=>{var l;e?(console.error(`Failed to kill process ${s}:`,e),f.includes("Access is denied")||(l=e.message)!=null&&l.includes("Access is denied")?(console.log("Access denied. Retrying with Admin privileges..."),v.exec(`powershell Start-Process taskkill -ArgumentList '/IM "${s}" /F' -Verb RunAs`,b=>{b?(console.error("Failed to kill process as Admin:",b),r(!1)):(console.log(`Successfully triggered Admin kill for ${s}`),r(!0))})):r(!1)):(console.log(`Successfully killed ${s}`),r(!0))})})});const O=process.env.VITE_DEV_SERVER_URL;let a=null;i.ipcMain.handle("scan-games",async()=>{console.log("Starting smart game scan...");const n=[],s=await(async()=>new Promise(o=>{v.exec("wmic logicaldisk get name",(m,p)=>{if(m){o(["C:","D:","E:"]);return}const h=p.split(`
`).map(S=>S.trim()).filter(S=>/^[A-Z]:$/.test(S));o(h.length>0?h:["C:","D:","E:"])})}))();console.log("Detected drives:",s);const r=["unins","setup","update","crash","config","redist","framework","helper","sys","dx","vcredist","microsoft","windows","common files","internet explorer","reference assemblies","windows defender"],e=["steam_api.dll","steam_api64.dll","galaxy.dll","UnityPlayer.dll","fmod.dll","D3Dcompiler_47.dll","os_api.dll","bink2w64.dll"],C=o=>{try{return c.readdirSync(o).some(m=>e.includes(m))}catch{return!1}},f=o=>{const m=o.match(/"name"\s+"([^"]+)"/i),p=o.match(/"installdir"\s+"([^"]+)"/i),h=o.match(/"appid"\s+"(\d+)"/i);return m&&p?{name:m[1],installDir:p[1],appId:h?h[1]:void 0}:null},l=["C:\\Program Files (x86)\\Steam","C:\\Program Files\\Steam"];for(const o of s)l.push(`${o}\\SteamLibrary`),l.push(`${o}\\Steam`);const b=["C:\\Program Files (x86)\\Steam","C:\\Program Files\\Steam",...s.map(o=>`${o}\\Steam`)];for(const o of b){const m=d.join(o,"steamapps","libraryfolders.vdf");if(c.existsSync(m))try{const h=c.readFileSync(m,"utf-8").match(/"path"\s+"([^"]+)"/g);h&&h.forEach(S=>{const u=S.split('"')[3].replace(/\\\\/g,"\\");l.includes(u)||l.push(u)})}catch(p){console.error("Error parsing libraryfolders.vdf:",p)}}for(const o of l){const m=d.join(o,"steamapps");if(c.existsSync(m))try{const p=c.readdirSync(m);for(const h of p)if(h.startsWith("appmanifest_")&&h.endsWith(".acf"))try{const S=c.readFileSync(d.join(m,h),"utf-8"),u=f(S);if(u){const $=d.join(m,"common",u.installDir);if(c.existsSync($))try{const P=c.readdirSync($).filter(x=>x.toLowerCase().endsWith(".exe"));let w="";if(w=P.find(x=>x.toLowerCase().includes(u.installDir.toLowerCase()))||"",w||(w=P.find(x=>["launcher.exe","game.exe","start.exe"].includes(x.toLowerCase()))||""),!w&&P.length>0){const x=P.map(L=>{try{return{name:L,size:c.statSync(d.join($,L)).size}}catch{return{name:L,size:0}}});x.sort((L,M)=>M.size-L.size),w=x[0].name}w&&n.push({name:u.name,path:d.join($,w),steamAppId:u.appId})}catch{}}}catch{}}catch{}}const F=o=>{if(c.existsSync(o))try{const m=c.readdirSync(o);for(const p of m){if(r.some(S=>p.toLowerCase().includes(S)))continue;const h=d.join(o,p);try{if(c.statSync(h).isDirectory()){const S=o.toLowerCase().includes("program files"),u=C(h);if(S&&!u)continue;if(u||!S){const P=c.readdirSync(h).filter(w=>w.toLowerCase().endsWith(".exe")).filter(w=>!r.some(x=>w.toLowerCase().includes(x)));if(P.length>0){let w=P.find(x=>x.toLowerCase().includes(p.toLowerCase()));if(w||(w=P.sort((x,L)=>c.statSync(d.join(h,L)).size-c.statSync(d.join(h,x)).size)[0]),w){const x=c.statSync(d.join(h,w)).size;if(!u&&x<20*1024*1024)continue;n.push({name:p,path:d.join(h,w)})}}}}}catch{}}}catch{}},y=["C:\\Games","C:\\Program Files\\Epic Games","C:\\Program Files\\GOG Galaxy\\Games","C:\\Program Files (x86)","C:\\Program Files"];for(const o of s)o!=="C:"&&(y.push(`${o}\\Games`),y.push(`${o}\\Epic Games`),y.push(`${o}\\Program Files\\Epic Games`),y.push(`${o}\\GOG Galaxy\\Games`));for(const o of y)F(o);await new Promise(o=>{v.exec('reg query "HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall" /s',(m,p)=>{var $,G;if(m){o();return}const h=p.split(`
`);let S="",u="";for(const P of h)if(P.trim().startsWith("DisplayName")&&(S=($=P.split("REG_SZ")[1])==null?void 0:$.trim()),P.trim().startsWith("InstallLocation")&&(u=(G=P.split("REG_SZ")[1])==null?void 0:G.trim()),S&&u&&P.trim()===""){if(u&&c.existsSync(u)){const w=C(u),x=u.toLowerCase().includes("games")||u.toLowerCase().includes("steam")||u.toLowerCase().includes("epic");if(w||x)try{const M=c.readdirSync(u).filter(j=>j.toLowerCase().endsWith(".exe"));let I=M.find(j=>j.toLowerCase().includes(S.toLowerCase()));I||(I=M.sort((j,T)=>c.statSync(d.join(u,T)).size-c.statSync(d.join(u,j)).size)[0]),I&&n.push({name:S,path:d.join(u,I)})}catch{}}S="",u=""}o()})});const D=n.filter((o,m,p)=>m===p.findIndex(h=>h.path===o.path)),k=[],A=new Set;for(const o of D)A.has(o.name)||(A.add(o.name),k.push(o));return console.log(`Scan complete. Found ${k.length} games.`),k});const B=d.join(process.cwd(),"debug_log.txt"),g=n=>{try{c.appendFileSync(B,`[${new Date().toISOString()}] ${n}
`)}catch(t){console.error("Failed to write to log file:",t)}},q=async(n,t)=>{g(`Attempting to take screenshot for ${n} (Exe: ${t})...`);try{const s=i.screen.getPrimaryDisplay(),r=await i.desktopCapturer.getSources({types:["window","screen"],thumbnailSize:s.size,fetchWindowIcons:!1});let e=null;const C=t?d.basename(t,d.extname(t)).toLowerCase():"";if(e||(e=r.find(f=>f.name.toLowerCase()===n.toLowerCase()),e&&g(`Found window matching game title: ${e.name}`)),!e&&C&&(e=r.find(f=>f.name.toLowerCase().includes(C)),e&&g(`Found window matching executable name: ${e.name}`)),e||(e=r.find(f=>f.name.toLowerCase().includes(n.toLowerCase())),e&&g(`Found window fuzzy matching game title: ${e.name}`)),e||(g("No matching window found. Falling back to primary display."),e=r.find(f=>f.display_id===s.id.toString())||r.find(f=>f.name==="Entire Screen")||r[0]),e){const f=e.thumbnail,l=d.join(i.app.getPath("userData"),"screenshots",n);c.existsSync(l)||c.mkdirSync(l,{recursive:!0});const F=`screenshot-${new Date().toISOString().replace(/[:.]/g,"-")}.png`,y=d.join(l,F);c.writeFileSync(y,f.toPNG()),g(`Screenshot saved to: ${y}`),a==null||a.webContents.send("screenshot-captured",{path:y,gameName:n})}else g("No source found for screenshot.")}catch(s){g(`Failed to take screenshot: ${s}`),console.error("Failed to take screenshot:",s)}},R=(n,t)=>{g(`Attempting to register screenshot shortcut for ${n}`);const s=["F12","CommandOrControl+F12","F9"];let r=!1;for(const e of s)try{if(i.globalShortcut.isRegistered(e)&&(g(`${e} is already registered. Unregistering first...`),i.globalShortcut.unregister(e)),i.globalShortcut.register(e,()=>{g(`${e} pressed - Taking screenshot...`),q(n,t)})){g(`Screenshot shortcut (${e}) registered successfully.`),a==null||a.webContents.send("shortcut-registered",e),r=!0;break}else g(`Failed to register ${e}.`)}catch(C){g(`Error registering ${e}: ${C}`)}r||(g("All shortcut registration attempts failed."),a==null||a.webContents.send("shortcut-registration-failed"))},J=()=>{["F12","CommandOrControl+F12","F9"].forEach(t=>{i.globalShortcut.isRegistered(t)&&(i.globalShortcut.unregister(t),g(`Screenshot shortcut (${t}) unregistered`))})};let N=null;const U=()=>{if(N)return;console.log("Starting global game monitoring..."),g("Starting global game monitoring...");const n=new Set;let t=null;N=setInterval(async()=>{const s=z.get("games");!s||!Array.isArray(s)||s.length===0||v.exec("tasklist /FO CSV /NH",(r,e)=>{if(r){g(`Tasklist error: ${r.message}`);return}const C=e.toLowerCase(),f=new Set;for(const l of s)if(l.executablePath){const b=d.basename(l.executablePath).toLowerCase(),F=l.executablePath.toLowerCase();C.includes(`"${b}"`)&&(f.add(F),n.has(F)||(g(`MATCH FOUND! ${b} started.`),n.add(F),a==null||a.webContents.send("game-detected",l),t=l.title,R(l.title,l.executablePath)))}for(const l of n)if(!f.has(l)){g(`Game exited: ${d.basename(l)}`),n.delete(l);const b=s.find(F=>{var y;return((y=F.executablePath)==null?void 0:y.toLowerCase())===l});if(b&&(a==null||a.webContents.send("game-exited",b),t===b.title&&(J(),t=null,n.size>0))){const F=Array.from(n)[0],y=s.find(E=>{var D;return((D=E.executablePath)==null?void 0:D.toLowerCase())===F});y&&(t=y.title,R(y.title,y.executablePath))}}})},5e3)};function W(){const n=d.join(__dirname,"preload.js");console.log("Preload path:",n),a=new i.BrowserWindow({width:1280,height:800,minWidth:1024,minHeight:600,icon:d.join(process.env.VITE_PUBLIC||"","electron-vite.svg"),webPreferences:{preload:n,nodeIntegration:!0,contextIsolation:!0},frame:!1,titleBarStyle:"hidden",backgroundColor:"#000000"}),a.webContents.on("did-finish-load",()=>{a==null||a.webContents.send("main-process-message",new Date().toLocaleString())}),O&&a.loadURL(O)}i.app.on("window-all-closed",()=>{process.platform!=="darwin"&&(i.app.quit(),a=null)});i.app.on("activate",()=>{i.BrowserWindow.getAllWindows().length===0&&W()});i.app.whenReady().then(()=>{W(),U()});
